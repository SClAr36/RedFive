<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>çº¢äº”å†²å†²å†² - WebSocket å®¢æˆ·ç«¯</title>
  <style>
    /* ---------- åŸºç¡€æ’ç‰ˆ ---------- */
    :root {
      --primary: #FF9AA2;      /* ä¸»è‰²è°ƒ-ç²‰ */
      --secondary: #FFB7B2;    /* è¾…åŠ©è‰²-æµ…ç²‰ */
      --accent: #FFDAC1;       /* å¼ºè°ƒè‰²-ç±³é»„ */
      --light: #E2F0CB;       /* äº®è‰²-è–„è·ç»¿ */
      --dark: #B5EAD7;        /* æš—è‰²-æµ…ç»¿ */
      --text: #5E5E5E;        /* æ­£æ–‡æ–‡å­— */
      --text-light: #888;     /* æµ…è‰²æ–‡å­— */
      --white: #FFFFFF;       /* çº¯ç™½ */
      --shadow: 0 4px 12px rgba(0,0,0,0.08); /* æ ‡å‡†é˜´å½± */
    }

    body {
      font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #F8F8F8;
      color: var(--text);
      line-height: 1.6;
    }

    h2 {
      color: var(--primary);
      text-align: center;
      margin-bottom: 20px;
      font-size: 28px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    /* ---------- æˆ¿é—´çŠ¶æ€ ---------- */
    #room-status {
      background-color: var(--white);
      padding: 14px;
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      font-weight: 500;
      text-align: center;
      min-height: 20px;
      border-left: 5px solid var(--primary);
      color: var(--primary);
      font-size: 16px;
    }

    /* ---------- æ¸¸æˆåŒºåŸŸå¸ƒå±€ ---------- */
    .game-area {
      display: flex;
      gap: 24px;
    }

    /* ä¸¤ä¾§é¢æ¿ç»Ÿä¸€æ ·å¼ */
    .side-panel {
      flex: 1;
      min-width: 260px;
      max-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* ä¸­é—´æ‰‹ç‰ŒåŒº */
    .card-area {
      flex: 2;
      background-color: var(--white);
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }

    /* ---------- æ‰‹ç‰ŒåŒºæ ·å¼ ---------- */
    #hand { 
      position: relative; 
      min-height: 120px; 
      margin: 24px 0; 
    }

    .card-container { 
      position: relative; 
      width: 100%; 
      margin-bottom: 24px; 
    }

    .card-row { 
      display: flex; 
      justify-content: center; 
      width: 100%; 
      position: relative; 
    }

    .card-row:nth-child(2) { 
      top: 2px; 
      margin-left: 2px; 
    }

    .card {
      position: relative;
      width: 64px;
      height: 96px;
      background-color: var(--white);
      border-radius: 8px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      cursor: pointer;
      user-select: none;
      transform-origin: center bottom;
      border: 2px solid var(--accent);
      margin-right: -42px;
    }

    .card-rank, .card-suit { 
      position: absolute; 
      left: 6px; 
    }
    .card-rank { 
      top: 6px; 
      font-size: 16px; 
    }
    .card-suit { 
      top: 26px; 
      font-size: 16px; 
    }

    .card:hover {
      transform: translateY(-10px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
      z-index: 5;
    }

    .card.selected {
      transform: translateY(-24px);
      border: 2px solid var(--primary);
      box-shadow: 0 12px 24px rgba(0,0,0,0.2);
      z-index: 10;
    }

    .card[data-suit="â™¥"] .card-rank,
    .card[data-suit="â™¥"] .card-suit,
    .card[data-suit="â™¦"] .card-rank,
    .card[data-suit="â™¦"] .card-suit { color: #FF5A5F; }

    .card[data-suit="â™ "] .card-rank,
    .card[data-suit="â™ "] .card-suit,
    .card[data-suit="â™£"] .card-rank,
    .card[data-suit="â™£"] .card-suit { color: #3A3A3A; }

    #hidden {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 24px 0;
      justify-content: center;
    }

    #hidden span {
      display: inline-block;
      padding: 10px 16px;
      font-size: 14px;
      border: 2px solid var(--accent);
      border-radius: 8px;
      min-width: 42px;
      text-align: center;
      background-color: var(--white);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: all 0.2s;
    }

    /* ---------- å‡ºç‰Œè®°å½•é¢æ¿ ---------- */
    .play-log-panel {
      background-color: var(--white);
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      height: 520px;
      display: flex;
      flex-direction: column;
    }

    .play-log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .play-log-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      background-color: rgba(255, 218, 193, 0.1);
      border-radius: 8px;
      font-family: 'Consolas', monospace;
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.5;
      color: var(--text);
      border: 1px solid rgba(255, 218, 193, 0.3);
      margin-bottom: 12px;
    }

    /* ç‰ŒèŠ±è‰²é¢œè‰² */
    .play-log-content .card-heart,
    .play-log-content .card-diamond {
      color: #FF5A5F;
    }
    
    .play-log-content .card-spade,
    .play-log-content .card-club {
      color: #3A3A3A;
    }

    /* ---------- å¾—åˆ†æ˜¾ç¤ºåŒº ---------- */
    .score-display {
      display: flex;
      justify-content: space-between;
      background: rgba(181, 234, 215, 0.2);
      border-radius: 8px;
      padding: 12px 16px;
      margin-top: auto;
      border: 1px solid rgba(181, 234, 215, 0.3);
    }

    .team-score {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }

    .team-score:first-child {
      border-right: 1px dashed rgba(0,0,0,0.1);
    }

    .team-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }

    .team-points {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }

    .team-a .team-points {
      color: #FF5A5F;
    }

    .team-b .team-points {
      color: #5A8DFF;
    }

    /* ---------- èŠå¤©åŒº ---------- */
    .chat-area {
      background-color: var(--white);
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      height: 520px;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255, 154, 162, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      background-color: rgba(229, 240, 203, 0.2);
      border-radius: 8px;
      margin-bottom: 16px;
      max-height: calc(100% - 60px);
      border: 1px solid rgba(229, 240, 203, 0.3);
    }

    .message {
      margin-bottom: 12px;
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
      transition: all 0.2s;
    }

    .message-other {
      align-self: flex-start;
      background-color: var(--secondary);
      color: var(--text);
      border-top-left-radius: 4px;
    }

    .message-self {
      align-self: flex-end;
      background-color: var(--primary);
      color: white;
      border-top-right-radius: 4px;
    }

    .message-sender {
      font-size: 12px;
      color: var(--text-light);
      margin-bottom: 4px;
      font-weight: 500;
    }

    .message-self .message-sender {
      text-align: right;
      color: rgba(255,255,255,0.8);
    }

    .chat-input {
      display: flex;
      gap: 12px;
    }

    .chat-input input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--accent);
      border-radius: 24px;
      font-size: 14px;
      transition: border-color 0.3s;
      background-color: rgba(255, 218, 193, 0.1);
    }

    .chat-input input:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* ---------- æŒ‰é’®æ ·å¼ ---------- */
    button {
      padding: 12px 20px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 24px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 5 00;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(255, 154, 162, 0.3);
    }

    button:hover {
      background-color: #FF7B85;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 154, 162, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    /* ç‰¹æ®ŠæŒ‰é’®æ ·å¼ */
    .action-buttons button {
      min-width: 100px;
    }

    .game-prepare button {
      background-color: var(--dark);
      box-shadow: 0 2px 6px rgba(181, 234, 215, 0.3);
    }

    .game-prepare button:hover {
      background-color: #9DD9C5;
      box-shadow: 0 4px 12px rgba(181, 234, 215, 0.4);
    }

    .chat-input button {
      background-color: var(--primary);
      padding: 12px 20px;
    }

    /* æ¸…ç©ºæŒ‰é’® */
    .play-log-header button {
      background-color: var(--light);
      color: var(--text);
      padding: 8px 16px;
      font-size: 13px;
      box-shadow: 0 2px 6px rgba(226, 240, 203, 0.3);
    }

    .play-log-header button:hover {
      background-color: #D0E6B3;
      box-shadow: 0 4px 12px rgba(226, 240, 203, 0.4);
    }

    /* ---------- æ ‡é¢˜æ ·å¼ ---------- */
    .section-title { 
      color: var(--primary); 
      margin-bottom: 16px; 
      font-size: 18px; 
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    /* ---------- æŒ‰é’®ç»„ ---------- */
    .button-group { 
      display: flex; 
      gap: 16px; 
      margin-top: 16px; 
      justify-content: center; 
    }

    .action-buttons {
      display: flex;
      gap: 16px;
      margin: 24px 0;
      position: relative;
      z-index: 20;
      justify-content: center;
    }

    .game-prepare { 
      display: flex; 
      gap: 16px; 
      margin-bottom: 24px; 
      justify-content: center;
    }

    /* ---------- æŠ½å±‰å¼æ¸¸æˆæ—¥å¿— ---------- */
    #toggle-log-btn {
      position: fixed;
      top: 24px;
      right: 24px;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: var(--primary);
      color: var(--white);
      border: none;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(255, 154, 162, 0.4);
      cursor: pointer;
      transition: all 0.3s;
      z-index: 110;
    }

    #toggle-log-btn:hover { 
      background: #FF7B85;
      transform: scale(1.1);
    }

    #log-panel {
      position: fixed;
      top: 0;
      right: -380px;
      width: 380px;
      height: 100%;
      background: var(--white);
      box-shadow: -4px 0 16px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      transition: right 0.3s ease;
      z-index: 100;
    }

    #log-panel.open { right: 0; }

    .log-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--primary);
      color: var(--white);
      padding: 16px 20px;
      font-size: 18px;
      font-weight: 600;
    }

    #close-log-btn {
      background: none;
      border: none;
      color: var(--white);
      font-size: 24px;
      line-height: 1;
      cursor: pointer;
      transition: transform 0.2s;
    }

    #close-log-btn:hover {
      transform: scale(1.2);
    }

    .game-log {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      font-family: 'Consolas', monospace;
      white-space: pre-wrap;
      color: var(--text);
      background-color: rgba(255, 218, 193, 0.1);
    }

    /* ---------- ç”¨æˆ·å›¾æ ‡æŒ‰é’® ---------- */
    .nickname-btn {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 20px;
      cursor: pointer;
      padding: 6px;
      border-radius: 50%;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nickname-btn:hover {
      background: rgba(255, 154, 162, 0.1);
      transform: rotate(15deg);
    }

    /* ---------- è‡ªå®šä¹‰æ»šåŠ¨æ¡ ---------- */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: rgba(255, 218, 193, 0.2); border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #FF7B85; }
  </style>
</head>
<body>
  <h2>çº¢äº”å†²å†²å†²</h2>
  <div id="room-status">ğŸ² æ¬¢è¿åŠ å…¥çº¢äº”å†²å†²å†²æ¸¸æˆï¼è¯·è®¾ç½®æ˜µç§°å¹¶å‡†å¤‡</div>

  <!-- å³ä¸Šè§’æ—¥å¿—æŒ‰é’® -->
  <button id="toggle-log-btn" title="æŸ¥çœ‹æ¸¸æˆæ—¥å¿—">ğŸ“œ</button>

  <!-- æŠ½å±‰å¼æ—¥å¿—é¢æ¿ -->
  <div id="log-panel">
    <div class="log-panel-header">
      <span>æ¸¸æˆæ—¥å¿—</span>
      <button id="close-log-btn" title="å…³é—­æ—¥å¿—">&times;</button>
    </div>
    <pre id="log" class="game-log"></pre>
  </div>

  <!-- æ¸¸æˆåŒºåŸŸ -->
  <div class="game-area">
    <!-- å·¦ä¾§ï¼šå‡ºç‰Œè®°å½• -->
    <div class="side-panel">
      <div class="play-log-panel">
        <div class="play-log-header">
          <h3 class="section-title">å‡ºç‰Œè®°å½•</h3>
          <button onclick="clearPlayLog()">ğŸ§¹ æ¸…ç©º</button>
        </div>
        <pre id="play-log" class="play-log-content"></pre>
        <div class="score-display">
          <div class="team-score team-a">
            <div class="team-name">é˜Ÿä¼ A</div>
            <div class="team-points" id="team-a-score">0</div>
          </div>
          <div class="team-score team-b">
            <div class="team-name">é˜Ÿä¼ B</div>
            <div class="team-points" id="team-b-score">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸­é—´ï¼šæ‰‹ç‰ŒåŒº -->
    <div class="card-area">
      <div class="game-prepare">
        <button onclick="selectTeam(0)">åŠ å…¥é˜Ÿä¼ A</button>
        <button onclick="selectTeam(1)">åŠ å…¥é˜Ÿä¼ B</button>
        <button onclick="updateTeam()">åˆ†é˜Ÿ</button>
        <button onclick="clearTeam()">æ’¤é”€é€‰é˜Ÿ</button>
        <button onclick="Ready()">å‡†å¤‡</button>
        <button onclick="promptTrump()">å‘ç‰Œ</button>
      </div>

      <h3 class="section-title">ä½ çš„æ‰‹ç‰Œï¼š</h3>
      <div id="hand">
        <div class="card-container" id="card-container"></div>
      </div>

      <div class="action-buttons">
        <button onclick="sendPlay()">å‡ºç‰Œ</button>
        <button onclick="hideCards()">è—ç‰Œ</button>
      </div>

      <h3 class="section-title">ä½ çš„åº•ç‰Œï¼š</h3>
      <div id="hidden"></div>
    </div>

    <!-- å³ä¾§ï¼šèŠå¤©åŒº -->
    <div class="side-panel">
      <div class="chat-area">
        <div class="chat-header">
          <span>æ¸¸æˆèŠå¤©</span>
          <button class="nickname-btn" onclick="setNicknameWithPrompt()" title="è®¾ç½®æ˜µç§°">ğŸ‘¤</button>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input">
          <input type="text" id="message" placeholder="è¾“å…¥èŠå¤©æ¶ˆæ¯..." onkeypress="handleChatInputKeyPress(event)">
          <button onclick="sendMessage()">å‘é€</button>
        </div>
      </div>
    </div>
  </div>

  <!-- è„šæœ¬ -->
  <script>
    const handDiv   = document.getElementById("card-container");
    const log       = document.getElementById('log');
    const playLog   = document.getElementById('play-log');
    const roomStatus = document.getElementById("room-status");
    const ws        = new WebSocket("ws://localhost:8765");
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message');
    const teamAScore = document.getElementById('team-a-score');
    const teamBScore = document.getElementById('team-b-score');

    /* æŠ½å±‰é¢æ¿å…ƒç´  */
    const toggleLogBtn = document.getElementById('toggle-log-btn');
    const logPanel     = document.getElementById('log-panel');
    const closeLogBtn  = document.getElementById('close-log-btn');

    /* æ—¥å¿—é¢æ¿æ§åˆ¶ */
    toggleLogBtn.addEventListener('click', () => {
      logPanel.classList.toggle('open');
    });
    closeLogBtn.addEventListener('click', () => {
      logPanel.classList.remove('open');
    });

    // åˆå§‹åŒ–æˆ¿é—´çŠ¶æ€
    roomStatus.textContent = "ğŸ² æ¬¢è¿åŠ å…¥çº¢äº”å†²å†²å†²æ¸¸æˆï¼è¯·è®¾ç½®æ˜µç§°å¹¶å‡†å¤‡";

    ws.onopen  = () => { log.textContent += "âœ… å·²è¿æ¥æœåŠ¡å™¨\n"; };
    ws.onclose = () => { log.textContent += "ğŸ”Œ è¿æ¥å…³é—­\n"; };

    let hand = [];
    let currentNickname = '';

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);

        switch (data.type) {
          case "welcome":
            log.textContent  = `æ¬¢è¿åŠ å…¥æˆ¿é—´ ${data.room_id}ï¼Œ${data.player_id}ï¼Œä½ æ˜¯ç©å®¶ ${data.player_number}\n`;
            roomStatus.textContent = `ğŸ‘‹ æ¬¢è¿åŠ å…¥æˆ¿é—´ ${data.room_id}ï¼Œä½ æ˜¯ç©å®¶ ${data.player_number}`;
            break;

          case "player_join":
            log.textContent += `ğŸ‘¤ ç©å®¶${data.player_id} (ç©å®¶${data.player_number}) åŠ å…¥äº†æˆ¿é—´ ${data.room_id}\n`;
            break;

          case "nickname_set":
            log.textContent += `ğŸ“› ç©å®¶${data.player_id} (ç©å®¶${data.player_number}) è®¾ç½®æ˜µç§°ä¸º ${data.nickname}\n`;
            if (data.player_name === currentNickname) {
              currentNickname = data.nickname;
            }
            break;

          case "chat":
            addChatMessage(data.player_name, data.content, data.player_name === currentNickname);
            break;

          case "ready_status":
            log.textContent += `ğŸƒ ${data.player_name} å‡†å¤‡å¥½äº†\n`;
            /* roomStatus.textContent = `ğŸƒ ${data.player_name} å·²å‡†å¤‡ï¼Œç­‰å¾…å‘ç‰Œ...`; */
            break;

          case "team_selected":
            addChatMessage("ç³»ç»Ÿ", `ç©å®¶${data.player_number}åŠ å…¥äº†${data.team_id === 0 ? 'A' : 'B'}é˜Ÿ`, false);
            break;

          case "update_player_numbers":
            addChatMessage("ç³»ç»Ÿ", `åˆ†é˜Ÿå®Œæˆ`, false);
            break;

          case "team_cleared":
            addChatMessage("ç³»ç»Ÿ", `åˆ†é˜Ÿå–æ¶ˆï¼Œè¯·å…¨ä½“ç©å®¶é‡æ–°é€‰æ‹©é˜Ÿä¼`, false);
            break;

          case "deal_start":
            roomStatus.textContent = `ğŸ¯ æœ¬è½®ä¸»æ•°ï¼š${data.rank_input}ï¼Œä¸»èŠ±è‰²ï¼š${data.suit_input}`;
            log.textContent += `ğŸ² å¼€å§‹å‘ç‰Œï¼ä¸»æ•°æ˜¯ ${data.rank_input}ï¼Œä¸»èŠ±è‰²æ˜¯ ${data.suit_input}\n`;
            // é‡ç½®åˆ†æ•°
            teamAScore.textContent = "0";
            teamBScore.textContent = "0";
            break;

          case "deal_done":
            log.textContent += `âœ… æˆ¿é—´ ${data.room_id} å‘ç‰Œå®Œæˆï¼\n`;
            break;

          case "your_hand":
            hand = data.hand;
            log.textContent += `ğŸƒ ä½ çš„æ‰‹ç‰Œæ›´æ–°ï¼ˆ${hand.length} å¼ ï¼‰\n`;
            updateHandDisplay();
            break;

          case "your_hidden":
            const hiddenDiv = document.getElementById("hidden");
            hiddenDiv.innerHTML = "";
            data.cards.forEach(card => {
              const el = document.createElement("span");
              el.textContent = card + " ";
              hiddenDiv.appendChild(el);
            });
            break;

          case "play_card":
            const cardsHtml = data.cards.map(card => {
              const suit = card.slice(-1);
              const className = suit === 'â™¥' ? 'card-heart' : 
                               suit === 'â™¦' ? 'card-diamond' :
                               suit === 'â™ ' ? 'card-spade' : 'card-club';
              return `<span class="${className}">${card}</span>`;
            }).join(", ");
            playLog.innerHTML += `ğŸ•¹ï¸ ${data.player_name} å‡ºäº†ç‰Œï¼š${cardsHtml}<br>ä¸‹ä¸€ä¸ªå‡ºç‰Œçš„ç©å®¶æ˜¯${data.expected_player}\n`;
            break;

          case "trick_done":
            playLog.innerHTML += `ğŸ‰ æœ¬è½® ç©å®¶ ${data.winner_player_number} èµ¢å¾—äº†æœ¬è½®ï¼${data.winning_team_id} é˜Ÿè·å¾—äº† ${data.trick_points} åˆ†ï¼\n`;
            // æ›´æ–°åˆ†æ•°
            if (data.result) {
              teamAScore.textContent = data.result[0] || 0;
              teamBScore.textContent = data.result[1] || 0;
            }
            break;

          case "error":
            alert("âš ï¸ é”™è¯¯ï¼š" + data.message);
            break;

          case "player_leave":
            log.textContent += `ğŸ‘‹ ${data.player_name} ç¦»å¼€äº†æˆ¿é—´ ${data.room_id}\n`;
            break;

          default:
            log.textContent += `ğŸ“© æ”¶åˆ°æœªçŸ¥ç±»å‹æ¶ˆæ¯: ${event.data}\n`;
        }

      } catch (e) {
        log.textContent += "ğŸ“© é JSON æ¶ˆæ¯: " + e.data + "\n";
      }
    };

    /* -------------------- è¾…åŠ©å‡½æ•° -------------------- */
    function setNicknameWithPrompt() {
      const nickname = prompt("è¯·è¾“å…¥ä½ çš„æ˜µç§°ï¼š");
      if (nickname && nickname.trim()) {
        currentNickname = nickname.trim();
        ws.send(JSON.stringify({ type: "set_nickname", nickname: currentNickname }));
        log.textContent += `ğŸ“› ä½ è®¾ç½®çš„æ˜µç§°æ˜¯ï¼š${currentNickname}\n`;
      }
    }

    function clearLog()     { log.textContent = ""; }
    function clearPlayLog() { playLog.textContent = ""; }

    function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;
      
      // ç«‹å³åœ¨èŠå¤©æ¡†ä¸­æ˜¾ç¤ºè‡ªå·±çš„æ¶ˆæ¯
      addChatMessage(currentNickname || "ä½ ", message, true);
      
      // å‘é€åˆ°æœåŠ¡å™¨
      ws.send(JSON.stringify({ type: "message", content: message }));
      
      // æ¸…ç©ºè¾“å…¥æ¡†å¹¶ä¿æŒç„¦ç‚¹
      messageInput.value = "";
      messageInput.focus();
    }

    function handleChatInputKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    function addChatMessage(sender, content, isSelf) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isSelf ? 'message-self' : 'message-other'}`;
      
      const senderDiv = document.createElement('div');
      senderDiv.className = 'message-sender';
      senderDiv.textContent = isSelf ? 'ä½ ' : sender;
      
      const contentDiv = document.createElement('div');
      contentDiv.textContent = content;
      
      messageDiv.appendChild(senderDiv);
      messageDiv.appendChild(contentDiv);
      chatMessages.appendChild(messageDiv);
      
      // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function selectTeam(teamId) {
      ws.send(JSON.stringify({ type: "select_team", team_id: teamId }));
    }

    function updateTeam() {
      ws.send(JSON.stringify({ type: "team_update" }));
    }

    function clearTeam() {
      ws.send(JSON.stringify({ type: "clear_team" }));
    }
    
    function Ready() {
      ws.send(JSON.stringify({ type: "ready" }));
      log.textContent += "ğŸƒ ä½ å‡†å¤‡å¥½äº†\n";
      //roomStatus.textContent = "ğŸƒ å·²å‡†å¤‡ï¼Œç­‰å¾…å…¶ä»–ç©å®¶...";
    }

    function dealCards() {
      ws.send(JSON.stringify({ type: "deal_cards" }));
    }

    function updateHandDisplay() {
      handDiv.innerHTML = "";
      const row1 = document.createElement("div"); row1.className = "card-row";
      const row2 = document.createElement("div"); row2.className = "card-row";

      const half = Math.ceil(hand.length / 2);
      const firstRowCards  = hand.slice(0, half);
      const secondRowCards = hand.slice(half);

      firstRowCards.forEach((card, idx) => row1.appendChild(createCardElement(card, idx)));
      secondRowCards.forEach((card, idx) => row2.appendChild(createCardElement(card, idx + half)));

      handDiv.appendChild(row1);
      handDiv.appendChild(row2);
    }

    function createCardElement(card, index) {
      const cardEl = document.createElement("div"); cardEl.className = "card";
      const rank = card.slice(0, -1); const suit = card.slice(-1);

      const rankEl = document.createElement("div"); rankEl.className = "card-rank"; rankEl.textContent = rank;
      const suitEl = document.createElement("div"); suitEl.className = "card-suit"; suitEl.textContent = suit;

      cardEl.appendChild(rankEl); cardEl.appendChild(suitEl);
      if (['â™¥','â™¦','â™ ','â™£'].includes(suit)) cardEl.setAttribute('data-suit', suit);

      cardEl.style.zIndex = index;
      cardEl.onclick = () => cardEl.classList.toggle("selected");
      return cardEl;
    }

    function sendPlay() {
      const selectedCards = [];
      document.querySelectorAll(".card.selected").forEach(card => {
        const rank = card.querySelector(".card-rank").textContent;
        const suit = card.querySelector(".card-suit").textContent;
        selectedCards.push(rank + suit);
      });
      if (selectedCards.length === 0) { alert("è¯·å…ˆé€‰æ‹©è¦å‡ºçš„ç‰Œï¼"); return; }
      ws.send(JSON.stringify({ type: "play_card", cards: selectedCards }));
      document.querySelectorAll(".card.selected").forEach(card => card.classList.remove("selected"));
    }

    function hideCards() {
      const selectedCards = [];
      document.querySelectorAll(".card.selected").forEach(card => {
        const rank = card.querySelector(".card-rank").textContent;
        const suit = card.querySelector(".card-suit").textContent;
        selectedCards.push(rank + suit);
      });
      if (selectedCards.length !== 8) { alert="è¯·é€‰æ‹©æ°å¥½ 8 å¼ ç‰Œä½œä¸ºåº•ç‰Œï¼"; return; }
      ws.send(JSON.stringify({ type: "hide_cards", cards: selectedCards }));
      document.querySelectorAll(".card.selected").forEach(card => card.classList.remove("selected"));
    }

    function promptTrump() {
      const rank = prompt("è¯·é€‰æ‹©æœ¬å±€çš„ä¸»æ•°ï¼ˆä¾‹å¦‚ 2~Aï¼‰");
      if (!rank || !["2","4","6","7","8","9","10","J","Q","K","A"].includes(rank)) {
        alert("æ— æ•ˆä¸»æ•°ï¼"); return;
      }
      const suits = ["â™ ","â™¥","â™£","â™¦"];
      const suit = suits[Math.floor(Math.random() * 4)];
      alert("ç³»ç»ŸéšæœºæŠ½å–çš„ä¸»èŠ±è‰²æ˜¯ï¼š" + suit);
      ws.send(JSON.stringify({ type: "deal_cards", rank_input: rank, suit_input: suit }));
    }
  </script>
</body>
</html>