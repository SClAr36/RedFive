<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>红五冲冲冲 - WebSocket 客户端</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
    }
    
    h2 {
      color: #d32f2f;
      text-align: center;
      margin-bottom: 20px;
      font-size: 28px;
    }
    
    #room-status {
      background-color: #fff;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      font-weight: bold;
      color: #d32f2f;
      text-align: center;
      min-height: 20px;
    }
    
    .control-panel {
      background-color: #fff;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .input-group {
      margin-bottom: 10px;
      display: flex;
      gap: 10px;
    }
    
    input[type="text"] {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      flex-grow: 1;
    }
    
    button {
      padding: 8px 15px;
      background-color: #d32f2f;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: #b71c1c;
    }
    
    .card-area {
      background-color: #fff;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #hand {
      position: relative;
      min-height: 150px;
      margin: 15px 0;
    }
    
    .card-container {
      position: relative;
      width: 100%;
      margin-bottom: 20px;
    }
    
    .card-row {
      display: flex;
      justify-content: center;
      width: 100%;
      position: relative;  /* 添加相对定位 */
    }
    
    .card-row:nth-child(2) {
      top: 1px;  /* 第二排下移60px（120px高度的一半） */
      margin-left: 1px;  /* 向右偏移40px让牌错开 */
    }
    
    .card {
      position: relative;
      width: 80px;
      height: 120px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      transition: all 0.3s ease;
      cursor: pointer;
      user-select: none;
      transform-origin: center bottom;
      border: 2px solid #ddd;
      margin-right: -50px;
    }
    
    .card-rank, .card-suit {
      position: absolute;
      left: 5px;  /* 距离左侧5px */
    }
    
    .card-rank {
      top: 5px;  /* 点数在上 */
    }
    
    .card-suit {
      top: 30px;  /* 花色在下，与点数保持间距 */
    }
    
    .card:hover {
      transform: translateY(-10px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    
    .card.selected {
      transform: translateY(-30px);
      border: 2px solid #d32f2f;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
      z-index: 10;
    }
    
    .card[data-suit="♥"] .card-rank,
    .card[data-suit="♥"] .card-suit,
    .card[data-suit="♦"] .card-rank,
    .card[data-suit="♦"] .card-suit {
      color: #d32f2f;
    }
    
    .card[data-suit="♠"] .card-rank,
    .card[data-suit="♠"] .card-suit,
    .card[data-suit="♣"] .card-rank,
    .card[data-suit="♣"] .card-suit {
      color: #333;
    }
    
    #hidden {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }
    
    #hidden span {
      display: inline-block;
      padding: 12px;
      font-size: 18px;
      border: 2px solid #ddd;
      border-radius: 8px;
      min-width: 50px;
      text-align: center;
      background-color: #f5f5f5;
    }
    
    #log {
      background-color: #333;
      color: #fff;
      padding: 15px;
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      position: relative;
      z-index: 20;
    }
    
    .section-title {
      color: #d32f2f;
      margin-bottom: 10px;
      font-size: 18px;
    }
    
    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .game-prepare {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
  </style> 
</head>
<body>
  <h2>红五冲冲冲</h2> 
  <div id="room-status">🎲 欢迎加入红五冲冲冲游戏！请设置昵称并准备</div>
  
  <div class="control-panel">
    <div class="input-group">
      <input type="text" id="nicknameInput" placeholder="输入昵称">
      <button onclick="setNickname()">设置昵称</button>
    </div>
    
    <div class="input-group">
      <input type="text" id="message" placeholder="输入聊天消息">
      <button onclick="sendMessage()">发送</button>
    </div>
  </div>
  
  <div class="card-area">
    <div class="game-prepare">
      <button onclick="Ready()">准备</button>
      <button onclick="promptTrump()">发牌</button>
    </div>
    
    <h3 class="section-title">你的手牌：</h3>
    <div id="hand">
      <div class="card-container" id="card-container"></div>
    </div>
    
    <div class="action-buttons">
      <button onclick="sendPlay()">出牌</button>
      <button onclick="hideCards()">藏牌</button>
    </div>
    
    <h3 class="section-title">你的底牌：</h3>
    <div id="hidden"></div>
  </div>
  
  <div class="log-header">
    <h3 class="section-title">游戏日志：</h3>
    <button onclick="clearLog()">🧹 清空日志</button>
  </div>
  <pre id="log"></pre>

  <script>
    const handDiv = document.getElementById("card-container");
    const log = document.getElementById('log');
    const roomStatus = document.getElementById("room-status");
    const ws = new WebSocket("ws://localhost:8765");    
    
    // 初始化房间状态
    roomStatus.textContent = "🎲 欢迎加入红五冲冲冲游戏！请设置昵称并准备";
    
    ws.onopen = () => {
      log.textContent += "✅ 已连接服务器\n";
    };    
    ws.onclose = () => log.textContent += "🔌 连接关闭\n";

    let hand = [];

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
    
        switch (data.type) {
          case "welcome":
            log.textContent = `欢迎加入房间 ${data.room_id}，${data.player_id}，你是玩家 ${data.player_number}\n`;
            roomStatus.textContent = `👋 欢迎加入房间 ${data.room_id}，你是玩家 ${data.player_number}`;
            break;
    
          case "player_join":
            log.textContent += `👤 玩家${data.player_id} (玩家${data.player_number}) 加入了房间 ${data.room_id}\n`;
            break;
          
          case "nickname_set":
            log.textContent += `📛 玩家${data.player_id} (玩家${data.player_number}) 设置昵称为 ${data.nickname}\n`;
            break;
          
          case "chat":
            log.textContent += `💬 ${data.player_name}：${data.content}\n`;
            break;
    
          case "ready_status":
            log.textContent += `🃏 ${data.player_name} 准备好了\n`;
            roomStatus.textContent = `🃏 ${data.player_name} 已准备，等待发牌...`;
            break;
            
          case "deal_start":
            const rank = data.rank_input;
            const suit = data.suit_input;
            roomStatus.textContent = `🎯 本轮主数：${rank}，主花色：${suit}`;
            log.textContent += `🎲 开始发牌！主数是 ${rank}，主花色是 ${suit}\n`;
            break;
    
          case "deal_done":
            log.textContent += `✅ 房间 ${data.room_id}发牌完成！\n`;
            break;
    
          case "your_hand":
            hand = data.hand;
            log.textContent += `🃏 你的手牌更新（${hand.length} 张）\n`;
            updateHandDisplay();
            break;
          
          case "your_hidden":
            const hiddenDiv = document.getElementById("hidden");
            hiddenDiv.innerHTML = "";
            data.cards.forEach(card => {
              const el = document.createElement("span");
              el.textContent = card + " ";
              hiddenDiv.appendChild(el);
            });
            break;

          case "play_card":
            log.textContent += `🕹️ ${data.player_name} 出了牌：${data.cards.join(", ")}\n`;
            break;
    
          case "error":
            alert("⚠️ 错误：" + data.message);
            break;
    
          case "player_leave":
            log.textContent += `👋 ${data.player_name} 离开了房间 ${data.room_id}\n`;
            break;
    
          default:
            log.textContent += `📩 收到未知类型消息: ${event.data}\n`;
        }
    
      } catch (e) {
        log.textContent += "📩 非 JSON 消息: " + e.data + "\n";
      }
    };
    
    function setNickname() {
      const nickname = document.getElementById("nicknameInput").value.trim();
      if (nickname) {
        ws.send(JSON.stringify({
          type: "set_nickname",
          nickname: nickname
        }));
        log.textContent += `📛 你设置的昵称是：${nickname}\n`;
        document.getElementById('nicknameInput').value = "";
        roomStatus.textContent = `📛 欢迎，${nickname}！请点击"准备"按钮`;
      }
    }    
    
    function clearLog() {
      log.textContent = "";
    }
    
    function sendMessage() {
      const message = document.getElementById('message').value;
      ws.send(JSON.stringify({
        type: "message",
        content: message
      }));
      log.textContent += "📩 你说: " + message + "\n";
      document.getElementById('message').value = "";
    }
    
    function Ready() {
      ws.send(JSON.stringify({
        type: "ready"
      }));
      log.textContent += "🃏 你准备好了\n";
      roomStatus.textContent = "🃏 已准备，等待其他玩家...";
    }
    
    function dealCards(){
      ws.send(JSON.stringify({
        type: "deal_cards"
      }));
    }
    
    function updateHandDisplay() {
      handDiv.innerHTML = "";
      
      const row1 = document.createElement("div");
      row1.className = "card-row";
      const row2 = document.createElement("div");
      row2.className = "card-row";
      
      const half = Math.ceil(hand.length / 2);
      const firstRowCards = hand.slice(0, half);
      const secondRowCards = hand.slice(half);
      
      firstRowCards.forEach((card, index) => {
        const cardEl = createCardElement(card, index);
        row1.appendChild(cardEl);
      });
      
      secondRowCards.forEach((card, index) => {
        const cardEl = createCardElement(card, index);
        row2.appendChild(cardEl);
      });
      
      handDiv.appendChild(row1);
      handDiv.appendChild(row2);
    }
    
    function createCardElement(card, index) {
      const cardEl = document.createElement("div");
      cardEl.className = "card";
      
      const rank = card.slice(0, -1);
      const suit = card.slice(-1);
      
      const rankEl = document.createElement("div");
      rankEl.className = "card-rank";
      rankEl.textContent = rank;
      
      const suitEl = document.createElement("div");
      suitEl.className = "card-suit";
      suitEl.textContent = suit;
      
      cardEl.appendChild(rankEl);
      cardEl.appendChild(suitEl);
      
      if (['♥', '♦', '♠', '♣'].includes(suit)) {
        cardEl.setAttribute('data-suit', suit);
      }
      
      cardEl.style.zIndex = index;
      
      cardEl.onclick = () => {
        cardEl.classList.toggle("selected");
      };
      
      return cardEl;
    }
    
    function sendPlay() {
      const selectedCards = [];
      document.querySelectorAll(".card.selected").forEach(card => {
        const rank = card.querySelector(".card-rank").textContent;
        const suit = card.querySelector(".card-suit").textContent;
        selectedCards.push(rank + suit);
      });
    
      if (selectedCards.length === 0) {
        alert("请先选择要出的牌！");
        return;
      }
    
      ws.send(JSON.stringify({
        type: "play_card",
        cards: selectedCards
      }));
      
      document.querySelectorAll(".card.selected").forEach(card => {
        card.classList.remove("selected");
      });
    }
    
    function hideCards() {
      const selectedCards = [];
      document.querySelectorAll(".card.selected").forEach(card => {
        const rank = card.querySelector(".card-rank").textContent;
        const suit = card.querySelector(".card-suit").textContent;
        selectedCards.push(rank + suit);
      });
    
      if (selectedCards.length !== 8) {
        alert("请选择恰好 8 张牌作为底牌！");
        return;
      }
    
      ws.send(JSON.stringify({
        type: "hide_cards",
        cards: selectedCards
      }));
      
      document.querySelectorAll(".card.selected").forEach(card => {
        card.classList.remove("selected");
      });
    }
    
    function promptTrump() {
      const rank = prompt("请选择本局的主数（例如 2~A）");
      if (!rank || !["2","4","6","7","8","9","10","J","Q","K","A"].includes(rank)) {
        alert("无效主数！");
        return;
      }
    
      const suits = ["♠", "♥", "♣", "♦"];
      const suit = suits[Math.floor(Math.random() * 4)];
      alert("系统随机抽取的主花色是：" + suit);
    
      ws.send(JSON.stringify({
        type: "deal_cards",
        rank_input: rank,
        suit_input: suit
      }));
    }
  </script>
</body>
</html>