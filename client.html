<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WebSocket 客户端</title>
    <!-- 样式放在这里 -->
    <style>
      #hand button.card-button {
        margin: 5px;
        padding: 10px;
        font-size: 18px;
        border: 1px solid #999;
        border-radius: 5px;
        cursor: pointer;
      }
  
      #hand button.card-button.selected {
        background-color: #ffd;
        border: 2px solid red;
      }
    </style> 
</head>
<body>
  <h2>红五冲冲冲</h2> 
  <button onclick="Ready()">准备</button>
  <button onclick="promptTrump()">选择主数后发牌</button>
  <!-- <button onclick="dealCards()">发牌</button>   -->

  <input type="text" id="message" placeholder="输入消息">
  <button onclick="sendMessage()">发送消息</button>
  <button onclick="ws.close()">关闭连接</button>
  <div>
    <h3>你的手牌是：</h3>
    <div id="hand"></div>             <!-- 放置手牌按钮 -->
    <button onclick="sendPlay()">出牌</button>
    <button onclick="hideCards()">藏牌</button>
    <h3>你的底牌是：</h3>
    <div id="hidden"></div>

  </div>
  <pre id="log"></pre>

  <script>
    const handDiv = document.getElementById("hand");
    const log = document.getElementById('log');
    const ws = new WebSocket("ws://localhost:8765");    
    
    ws.onopen = () => log.textContent += "✅ 已连接服务器\n";    
    ws.onclose = () => log.textContent += "🔌 连接关闭\n";

    let hand = [];

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
    
        switch (data.type) {
          case "welcome":
            log.textContent = `欢迎加入房间 ${data.room_id}，${data.player_id}，你是玩家 ${data.player_number}\n`;
            break;
    
          case "player_join":
            log.textContent += `👤 玩家${data.player_id} (玩家 ${data.player_number} ) 加入了房间 ${data.room_id}\n`;
            break;

          case "chat":
            log.textContent += `💬 玩家${data.player_number}：${data.content}\n`;
            break;
    
          case "ready_status":
            log.textContent += `🃏 玩家${data.player_number} 准备好了\n`;
            break;
    
          case "deal_start":
            log.textContent += `🎲 开始发牌！\n`;
            break;
    
          case "deal_done":
            log.textContent += `✅ 房间 ${data.room_id}发牌完成！\n`;
            break;
    
          case "your_hand":
            hand = data.hand;
            log.textContent += `🃏 你的手牌更新（${hand.length} 张）\n`;
            updateHandDisplay();
            break;
          
          case "your_hidden":
            const hiddenDiv = document.getElementById("hidden");
            hiddenDiv.innerHTML = "";
            data.cards.forEach(card => {
              const el = document.createElement("span");
              el.textContent = card + " ";
              hiddenDiv.appendChild(el);
            });
            break;

          case "play_card":
            log.textContent += `🕹️ 玩家${data.player_number} 出了牌：${data.cards.join(", ")}\n`;
            break;
    
          case "error":
            alert("⚠️ 错误：" + data.message);
            break;
    
          case "player_leave":
            log.textContent += `👋 玩家${data.player_number} 离开了房间 ${data.room_id}\n`;
            break;
    
          default:
            log.textContent += `📩 收到未知类型消息: ${e.data}\n`;
        }
    
      } catch {
        log.textContent += "📩 非 JSON 消息: " + e.data + "\n";
      }
    };
    

    function sendMessage() {
      const message = document.getElementById('message').value;
      ws.send(JSON.stringify({
        type: "message",
        content: message
      }));
      log.textContent += "📩 你说: " + message + "\n";
    }
    function Ready() {
      ws.send(JSON.stringify({
        type: "ready"
      }));
      log.textContent += "🃏 你准备好了\n";
    }
    function dealCards(){
      ws.send(JSON.stringify({
        type: "deal_cards"
      }));
    }
    
    function updateHandDisplay() {
      handDiv.innerHTML = "";  // 清空旧的手牌显示
    
      hand.forEach(card => {
        const btn = document.createElement("button");
        btn.textContent = card;
        btn.classList.add("card-button");
        btn.onclick = () => {
          btn.classList.toggle("selected");
        };
        handDiv.appendChild(btn);
      });
    }
    function sendPlay() {
      const selectedCards = [
        ...handDiv.querySelectorAll("button.card-button.selected")
      ].map(btn => btn.textContent);
    
      if (selectedCards.length === 0) {
        alert("请先选择要出的牌！");
        return;
      }
    
      ws.send(JSON.stringify({
        type: "play_card",
        cards: selectedCards
      }));
    }
    function hideCards() {
      const selectedCards = [
        ...handDiv.querySelectorAll("button.card-button.selected")
      ].map(btn => btn.textContent);
    
      if (selectedCards.length !== 8) {
        alert("请选择恰好 8 张牌作为底牌！");
        return;
      }
    
      ws.send(JSON.stringify({
        type: "hide_cards",
        cards: selectedCards
      }));
    }
    function promptTrump() {
      const rank = prompt("请选择本局的主数（例如 2~A）");
      if (!rank || !["2","4","6","7","8","9","10","J","Q","K","A"].includes(rank)) {
        alert("无效主数！");
        return;
      }
    
      const suits = ["♠", "♥", "♣", "♦"];
      const suit = suits[Math.floor(Math.random() * 4)];
      alert("系统随机抽取的主花色是：" + suit);
    
      ws.send(JSON.stringify({
        type: "deal_cards",
        rank_input: rank,
        suit_input: suit
      }));
    }
  </script>
</body>
</html>
