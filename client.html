<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WebSocket å®¢æˆ·ç«¯</title>
    <!-- æ ·å¼æ”¾åœ¨è¿™é‡Œ -->
    <style>
      #hand button.card-button {
        margin: 5px;
        padding: 10px;
        font-size: 18px;
        border: 1px solid #999;
        border-radius: 5px;
        cursor: pointer;
      }
  
      #hand button.card-button.selected {
        background-color: #ffd;
        border: 2px solid red;
      }
    </style> 
</head>
<body>
  <h2>çº¢äº”å†²å†²å†²</h2> 
  <button onclick="Ready()">å‡†å¤‡</button>
  <button onclick="promptTrump()">é€‰æ‹©ä¸»æ•°åå‘ç‰Œ</button>
  <!-- <button onclick="dealCards()">å‘ç‰Œ</button>   -->

  <input type="text" id="message" placeholder="è¾“å…¥æ¶ˆæ¯">
  <button onclick="sendMessage()">å‘é€æ¶ˆæ¯</button>
  <button onclick="ws.close()">å…³é—­è¿æ¥</button>
  <div>
    <h3>ä½ çš„æ‰‹ç‰Œæ˜¯ï¼š</h3>
    <div id="hand"></div>             <!-- æ”¾ç½®æ‰‹ç‰ŒæŒ‰é’® -->
    <button onclick="sendPlay()">å‡ºç‰Œ</button>
    <button onclick="hideCards()">è—ç‰Œ</button>
    <h3>ä½ çš„åº•ç‰Œæ˜¯ï¼š</h3>
    <div id="hidden"></div>

  </div>
  <pre id="log"></pre>

  <script>
    const handDiv = document.getElementById("hand");
    const log = document.getElementById('log');
    const ws = new WebSocket("ws://localhost:8765");    
    
    ws.onopen = () => log.textContent += "âœ… å·²è¿æ¥æœåŠ¡å™¨\n";    
    ws.onclose = () => log.textContent += "ğŸ”Œ è¿æ¥å…³é—­\n";

    let hand = [];

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
    
        switch (data.type) {
          case "welcome":
            log.textContent = `æ¬¢è¿åŠ å…¥æˆ¿é—´ ${data.room_id}ï¼Œ${data.player_id}ï¼Œä½ æ˜¯ç©å®¶ ${data.player_number}\n`;
            break;
    
          case "player_join":
            log.textContent += `ğŸ‘¤ ç©å®¶${data.player_id} (ç©å®¶ ${data.player_number} ) åŠ å…¥äº†æˆ¿é—´ ${data.room_id}\n`;
            break;

          case "chat":
            log.textContent += `ğŸ’¬ ç©å®¶${data.player_number}ï¼š${data.content}\n`;
            break;
    
          case "ready_status":
            log.textContent += `ğŸƒ ç©å®¶${data.player_number} å‡†å¤‡å¥½äº†\n`;
            break;
    
          case "deal_start":
            log.textContent += `ğŸ² å¼€å§‹å‘ç‰Œï¼\n`;
            break;
    
          case "deal_done":
            log.textContent += `âœ… æˆ¿é—´ ${data.room_id}å‘ç‰Œå®Œæˆï¼\n`;
            break;
    
          case "your_hand":
            hand = data.hand;
            log.textContent += `ğŸƒ ä½ çš„æ‰‹ç‰Œæ›´æ–°ï¼ˆ${hand.length} å¼ ï¼‰\n`;
            updateHandDisplay();
            break;
          
          case "your_hidden":
            const hiddenDiv = document.getElementById("hidden");
            hiddenDiv.innerHTML = "";
            data.cards.forEach(card => {
              const el = document.createElement("span");
              el.textContent = card + " ";
              hiddenDiv.appendChild(el);
            });
            break;

          case "play_card":
            log.textContent += `ğŸ•¹ï¸ ç©å®¶${data.player_number} å‡ºäº†ç‰Œï¼š${data.cards.join(", ")}\n`;
            break;
    
          case "error":
            alert("âš ï¸ é”™è¯¯ï¼š" + data.message);
            break;
    
          case "player_leave":
            log.textContent += `ğŸ‘‹ ç©å®¶${data.player_number} ç¦»å¼€äº†æˆ¿é—´ ${data.room_id}\n`;
            break;
    
          default:
            log.textContent += `ğŸ“© æ”¶åˆ°æœªçŸ¥ç±»å‹æ¶ˆæ¯: ${e.data}\n`;
        }
    
      } catch {
        log.textContent += "ğŸ“© é JSON æ¶ˆæ¯: " + e.data + "\n";
      }
    };
    

    function sendMessage() {
      const message = document.getElementById('message').value;
      ws.send(JSON.stringify({
        type: "message",
        content: message
      }));
      log.textContent += "ğŸ“© ä½ è¯´: " + message + "\n";
    }
    function Ready() {
      ws.send(JSON.stringify({
        type: "ready"
      }));
      log.textContent += "ğŸƒ ä½ å‡†å¤‡å¥½äº†\n";
    }
    function dealCards(){
      ws.send(JSON.stringify({
        type: "deal_cards"
      }));
    }
    
    function updateHandDisplay() {
      handDiv.innerHTML = "";  // æ¸…ç©ºæ—§çš„æ‰‹ç‰Œæ˜¾ç¤º
    
      hand.forEach(card => {
        const btn = document.createElement("button");
        btn.textContent = card;
        btn.classList.add("card-button");
        btn.onclick = () => {
          btn.classList.toggle("selected");
        };
        handDiv.appendChild(btn);
      });
    }
    function sendPlay() {
      const selectedCards = [
        ...handDiv.querySelectorAll("button.card-button.selected")
      ].map(btn => btn.textContent);
    
      if (selectedCards.length === 0) {
        alert("è¯·å…ˆé€‰æ‹©è¦å‡ºçš„ç‰Œï¼");
        return;
      }
    
      ws.send(JSON.stringify({
        type: "play_card",
        cards: selectedCards
      }));
    }
    function hideCards() {
      const selectedCards = [
        ...handDiv.querySelectorAll("button.card-button.selected")
      ].map(btn => btn.textContent);
    
      if (selectedCards.length !== 8) {
        alert("è¯·é€‰æ‹©æ°å¥½ 8 å¼ ç‰Œä½œä¸ºåº•ç‰Œï¼");
        return;
      }
    
      ws.send(JSON.stringify({
        type: "hide_cards",
        cards: selectedCards
      }));
    }
    function promptTrump() {
      const rank = prompt("è¯·é€‰æ‹©æœ¬å±€çš„ä¸»æ•°ï¼ˆä¾‹å¦‚ 2~Aï¼‰");
      if (!rank || !["2","4","6","7","8","9","10","J","Q","K","A"].includes(rank)) {
        alert("æ— æ•ˆä¸»æ•°ï¼");
        return;
      }
    
      const suits = ["â™ ", "â™¥", "â™£", "â™¦"];
      const suit = suits[Math.floor(Math.random() * 4)];
      alert("ç³»ç»ŸéšæœºæŠ½å–çš„ä¸»èŠ±è‰²æ˜¯ï¼š" + suit);
    
      ws.send(JSON.stringify({
        type: "deal_cards",
        rank_input: rank,
        suit_input: suit
      }));
    }
  </script>
</body>
</html>
