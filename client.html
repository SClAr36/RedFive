<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>红五冲冲冲 - WebSocket 客户端</title>
  <style>
    /* ---------- 基础排版 ---------- */
    body {
      font-family: 'Arial', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f8f9fa;
      color: #495057;
    }

    h2 {
      color: #d32f2f;
      text-align: center;
      margin-bottom: 20px;
      font-size: 28px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    /* ---------- 房间状态 ---------- */
    #room-status {
      background-color: #fff;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      font-weight: bold;
      text-align: center;
      min-height: 20px;
      border-left: 4px solid #6c757d;
    }

    /* ---------- 控制面板 ---------- */
    .control-panel {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .input-group {
      margin-bottom: 12px;
      display: flex;
      gap: 12px;
    }

    input[type="text"] {
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      flex-grow: 1;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #6c757d;
    }

    button {
      padding: 10px 18px;
      background-color: #495057;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
      font-size: 14px;
    }

    button:hover {
      background-color: #343a40;
      transform: translateY(-1px);
    }

    /* ---------- 游戏区域布局 ---------- */
    .game-area {
      display: flex;
      gap: 20px;
      margin-bottom: 25px;
    }

    /* ---------- 手牌区 ---------- */
    .card-area {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      flex: 2;
    }

    #hand { position: relative; min-height: 150px; margin: 20px 0; }

    .card-container { position: relative; width: 100%; margin-bottom: 20px; }

    .card-row { display: flex; justify-content: center; width: 100%; position: relative; }

    .card-row:nth-child(2) { top: 1px; margin-left: 1px; }

    .card {
      position: relative;
      width: 80px;
      height: 120px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      transition: all 0.3s ease;
      cursor: pointer;
      user-select: none;
      transform-origin: center bottom;
      border: 2px solid #e9ecef;
      margin-right: -50px;
    }

    .card-rank, .card-suit { position: absolute; left: 5px; }
    .card-rank { top: 5px; }
    .card-suit { top: 30px; }

    .card:hover {
      transform: translateY(-10px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .card.selected {
      transform: translateY(-30px);
      border: 2px solid #d32f2f;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      z-index: 10;
    }

    .card[data-suit="♥"] .card-rank,
    .card[data-suit="♥"] .card-suit,
    .card[data-suit="♦"] .card-rank,
    .card[data-suit="♦"] .card-suit { color: #d32f2f; }

    .card[data-suit="♠"] .card-rank,
    .card[data-suit="♠"] .card-suit,
    .card[data-suit="♣"] .card-rank,
    .card[data-suit="♣"] .card-suit { color: #212529; }

    #hidden {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 20px 0;
      justify-content: center;
    }

    #hidden span {
      display: inline-block;
      padding: 12px 16px;
      font-size: 16px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      min-width: 50px;
      text-align: center;
      background-color: #f8f9fa;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    /* ---------- 聊天区 ---------- */
    .chat-area {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 500px; /* 固定高度 */
    }

    .chat-header {
      font-size: 18px;
      font-weight: 600;
      color: #495057;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 15px;
      max-height: calc(100% - 60px); /* 确保不会超出容器 */
    }

    .message {
      margin-bottom: 12px;
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .message-other {
      align-self: flex-start;
      background-color: #e9ecef;
      border-top-left-radius: 4px;
      color: #212529;
    }

    .message-self {
      align-self: flex-end;
      background-color: #d32f2f;
      color: white;
      border-top-right-radius: 4px;
    }

    .message-sender {
      font-size: 12px;
      color: #6c757d;
      margin-bottom: 4px;
    }

    .message-self .message-sender {
      text-align: right;
      color: rgba(255,255,255,0.8);
    }

    .chat-input {
      display: flex;
      gap: 10px;
    }

    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 18px;
      font-size: 14px;
    }

    .chat-input button {
      padding: 10px 16px;
      border-radius: 18px;
      background-color: #d32f2f;
    }

    .chat-input button:hover {
      background-color: #b71c1c;
    }

    /* ---------- 日志、按钮 ---------- */
    .log-container {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }

    .play-log {
      flex: 1;
      background-color: #f8f9fa;
      color: #495057;
      padding: 15px;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-left: 4px solid #6c757d;
    }

    .button-group { display: flex; gap: 12px; margin-top: 12px; justify-content: center; }

    .action-buttons {
      display: flex;
      gap: 12px;
      margin: 20px 0;
      position: relative;
      z-index: 20;
      justify-content: center;
    }

    .section-title { color: #495057; margin-bottom: 12px; font-size: 18px; font-weight: 600; }

    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .game-prepare { display: flex; gap: 12px; margin-bottom: 20px; justify-content: center; }

    /* ---------- 抽屉式游戏日志 ---------- */
    #toggle-log-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #495057;
      color: #fff;
      border: none;
      font-size: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: background 0.3s;
      z-index: 110;
    }

    #toggle-log-btn:hover { background: #343a40; }

    #log-panel {
      position: fixed;
      top: 0;
      right: -360px;            /* 初始隐藏 */
      width: 360px;
      height: 100%;
      background: #f8f9fa;
      box-shadow: -2px 0 8px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      transition: right 0.3s ease;
      z-index: 100;
    }

    #log-panel.open { right: 0; }

    .log-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #343a40;
      color: #fff;
      padding: 12px 16px;
      font-size: 18px;
      font-weight: 600;
    }

    #close-log-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      line-height: 1;
      cursor: pointer;
    }

    .game-log {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      color: #495057;
    }

    /* ---------- 用户图标按钮 ---------- */
    .nickname-btn {
      background: none;
      border: none;
      color: #495057;
      font-size: 18px;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .nickname-btn:hover {
      background: #e9ecef;
    }

    /* ---------- 自定义滚动条 ---------- */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #adb5bd; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #6c757d; }
  </style>
</head>
<body>
  <h2>红五冲冲冲</h2>
  <div id="room-status">🎲 欢迎加入红五冲冲冲游戏！请设置昵称并准备</div>

  <!-- 右上角日志按钮 -->
  <button id="toggle-log-btn" title="查看游戏日志">📜</button>

  <!-- 抽屉式日志面板 -->
  <div id="log-panel">
    <div class="log-panel-header">
      <span>游戏日志</span>
      <button id="close-log-btn" title="关闭日志">&times;</button>
    </div>
    <pre id="log" class="game-log"></pre>
  </div>

  <!-- 游戏区域 ----------------------------------------------------------------- -->
  <div class="game-area">
    <!-- 手牌区 -->
    <div class="card-area">
      <div class="game-prepare">
        <button onclick="Ready()">准备</button>
        <button onclick="promptTrump()">发牌</button>
      </div>

      <h3 class="section-title">你的手牌：</h3>
      <div id="hand">
        <div class="card-container" id="card-container"></div>
      </div>

      <div class="action-buttons">
        <button onclick="sendPlay()">出牌</button>
        <button onclick="hideCards()">藏牌</button>
      </div>

      <h3 class="section-title">你的底牌：</h3>
      <div id="hidden"></div>
    </div>

    <!-- 聊天区 -->
    <div class="chat-area">
      <div class="chat-header">
        <span>游戏聊天</span>
        <button class="nickname-btn" onclick="setNicknameWithPrompt()" title="设置昵称">👤</button>
      </div>
      <div class="chat-messages" id="chat-messages"></div>
      <div class="chat-input">
        <input type="text" id="message" placeholder="输入聊天消息..." onkeypress="handleChatInputKeyPress(event)">
        <button onclick="sendMessage()">发送</button>
      </div>
    </div>
  </div>

  <!-- 记录区 ----------------------------------------------------------------- -->
  <div class="log-container">
    <div style="flex: 1; min-width: 0;">
      <div class="log-header">
        <h3 class="section-title">出牌记录：</h3>
        <button onclick="clearPlayLog()">🧹 清空记录</button>
      </div>
      <pre id="play-log" class="play-log"></pre>
    </div>
    <!-- 游戏日志已移至抽屉面板 -->
  </div>

  <!-- 脚本 ------------------------------------------------------------------- -->
  <script>
    const handDiv   = document.getElementById("card-container");
    const log       = document.getElementById('log');
    const playLog   = document.getElementById('play-log');
    const roomStatus = document.getElementById("room-status");
    const ws        = new WebSocket("ws://localhost:8765");
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message');

    /* 抽屉面板元素 */
    const toggleLogBtn = document.getElementById('toggle-log-btn');
    const logPanel     = document.getElementById('log-panel');
    const closeLogBtn  = document.getElementById('close-log-btn');

    /* 日志面板控制 */
    toggleLogBtn.addEventListener('click', () => {
      logPanel.classList.toggle('open');
    });
    closeLogBtn.addEventListener('click', () => {
      logPanel.classList.remove('open');
    });

    // 初始化房间状态
    roomStatus.textContent = "🎲 欢迎加入红五冲冲冲游戏！请设置昵称并准备";

    ws.onopen  = () => { log.textContent += "✅ 已连接服务器\n"; };
    ws.onclose = () => { log.textContent += "🔌 连接关闭\n"; };

    let hand = [];
    let currentNickname = '';

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);

        switch (data.type) {
          case "welcome":
            log.textContent  = `欢迎加入房间 ${data.room_id}，${data.player_id}，你是玩家 ${data.player_number}\n`;
            roomStatus.textContent = `👋 欢迎加入房间 ${data.room_id}，你是玩家 ${data.player_number}`;
            break;

          case "player_join":
            log.textContent += `👤 玩家${data.player_id} (玩家${data.player_number}) 加入了房间 ${data.room_id}\n`;
            break;

          case "nickname_set":
            log.textContent += `📛 玩家${data.player_id} (玩家${data.player_number}) 设置昵称为 ${data.nickname}\n`;
            if (data.player_name === currentNickname) {
              currentNickname = data.nickname;
            }
            break;

          case "chat":
            addChatMessage(data.player_name, data.content, data.player_name === currentNickname);
            log.textContent += `💬 ${data.player_name}：${data.content}\n`;
            break;

          case "ready_status":
            log.textContent += `🃏 ${data.player_name} 准备好了\n`;
            roomStatus.textContent = `🃏 ${data.player_name} 已准备，等待发牌...`;
            break;

          case "deal_start":
            roomStatus.textContent = `🎯 本轮主数：${data.rank_input}，主花色：${data.suit_input}`;
            log.textContent += `🎲 开始发牌！主数是 ${data.rank_input}，主花色是 ${data.suit_input}\n`;
            break;

          case "deal_done":
            log.textContent += `✅ 房间 ${data.room_id} 发牌完成！\n`;
            break;

          case "your_hand":
            hand = data.hand;
            log.textContent += `🃏 你的手牌更新（${hand.length} 张）\n`;
            updateHandDisplay();
            break;

          case "your_hidden":
            const hiddenDiv = document.getElementById("hidden");
            hiddenDiv.innerHTML = "";
            data.cards.forEach(card => {
              const el = document.createElement("span");
              el.textContent = card + " ";
              hiddenDiv.appendChild(el);
            });
            break;

          case "play_card":
            playLog.textContent += `🕹️ ${data.player_name} 出了牌：${data.cards.join(", ")}\n`;
            break;

          case "trick_done":
            playLog.textContent += `🎉 本轮 ${data.winner_player_number} 赢得了本轮！${data.winning_team_id} 获得了 ${data.points} 分！\n`;
            break;

          case "error":
            alert("⚠️ 错误：" + data.message);
            break;

          case "player_leave":
            log.textContent += `👋 ${data.player_name} 离开了房间 ${data.room_id}\n`;
            break;

          default:
            log.textContent += `📩 收到未知类型消息: ${event.data}\n`;
        }

      } catch (e) {
        log.textContent += "📩 非 JSON 消息: " + e.data + "\n";
      }
    };

    /* -------------------- 辅助函数 -------------------- */
    function setNicknameWithPrompt() {
      const nickname = prompt("请输入你的昵称：");
      if (nickname && nickname.trim()) {
        currentNickname = nickname.trim();
        ws.send(JSON.stringify({ type: "set_nickname", nickname: currentNickname }));
        log.textContent += `📛 你设置的昵称是：${currentNickname}\n`;
      }
    }

    function clearLog()     { log.textContent = ""; }
    function clearPlayLog() { playLog.textContent = ""; }

    function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;
      
      // 立即在聊天框中显示自己的消息
      addChatMessage(currentNickname || "你", message, true);
      
      // 发送到服务器
      ws.send(JSON.stringify({ type: "message", content: message }));
      
      // 清空输入框并保持焦点
      messageInput.value = "";
      messageInput.focus();
    }

    function handleChatInputKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    function addChatMessage(sender, content, isSelf) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isSelf ? 'message-self' : 'message-other'}`;
      
      const senderDiv = document.createElement('div');
      senderDiv.className = 'message-sender';
      senderDiv.textContent = isSelf ? '你' : sender;
      
      const contentDiv = document.createElement('div');
      contentDiv.textContent = content;
      
      messageDiv.appendChild(senderDiv);
      messageDiv.appendChild(contentDiv);
      chatMessages.appendChild(messageDiv);
      
      // 自动滚动到底部
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function Ready() {
      ws.send(JSON.stringify({ type: "ready" }));
      log.textContent += "🃏 你准备好了\n";
      roomStatus.textContent = "🃏 已准备，等待其他玩家...";
    }

    function dealCards() {
      ws.send(JSON.stringify({ type: "deal_cards" }));
    }

    function updateHandDisplay() {
      handDiv.innerHTML = "";
      const row1 = document.createElement("div"); row1.className = "card-row";
      const row2 = document.createElement("div"); row2.className = "card-row";

      const half = Math.ceil(hand.length / 2);
      const firstRowCards  = hand.slice(0, half);
      const secondRowCards = hand.slice(half);

      firstRowCards.forEach((card, idx) => row1.appendChild(createCardElement(card, idx)));
      secondRowCards.forEach((card, idx) => row2.appendChild(createCardElement(card, idx + half)));

      handDiv.appendChild(row1);
      handDiv.appendChild(row2);
    }

    function createCardElement(card, index) {
      const cardEl = document.createElement("div"); cardEl.className = "card";
      const rank = card.slice(0, -1); const suit = card.slice(-1);

      const rankEl = document.createElement("div"); rankEl.className = "card-rank"; rankEl.textContent = rank;
      const suitEl = document.createElement("div"); suitEl.className = "card-suit"; suitEl.textContent = suit;

      cardEl.appendChild(rankEl); cardEl.appendChild(suitEl);
      if (['♥','♦','♠','♣'].includes(suit)) cardEl.setAttribute('data-suit', suit);

      cardEl.style.zIndex = index;
      cardEl.onclick = () => cardEl.classList.toggle("selected");
      return cardEl;
    }

    function sendPlay() {
      const selectedCards = [];
      document.querySelectorAll(".card.selected").forEach(card => {
        const rank = card.querySelector(".card-rank").textContent;
        const suit = card.querySelector(".card-suit").textContent;
        selectedCards.push(rank + suit);
      });
      if (selectedCards.length === 0) { alert("请先选择要出的牌！"); return; }
      ws.send(JSON.stringify({ type: "play_card", cards: selectedCards }));
      document.querySelectorAll(".card.selected").forEach(card => card.classList.remove("selected"));
    }

    function hideCards() {
      const selectedCards = [];
      document.querySelectorAll(".card.selected").forEach(card => {
        const rank = card.querySelector(".card-rank").textContent;
        const suit = card.querySelector(".card-suit").textContent;
        selectedCards.push(rank + suit);
      });
      if (selectedCards.length !== 8) { alert("请选择恰好 8 张牌作为底牌！"); return; }
      ws.send(JSON.stringify({ type: "hide_cards", cards: selectedCards }));
      document.querySelectorAll(".card.selected").forEach(card => card.classList.remove("selected"));
    }

    function promptTrump() {
      const rank = prompt("请选择本局的主数（例如 2~A）");
      if (!rank || !["2","4","6","7","8","9","10","J","Q","K","A"].includes(rank)) {
        alert("无效主数！"); return;
      }
      const suits = ["♠","♥","♣","♦"];
      const suit = suits[Math.floor(Math.random() * 4)];
      alert("系统随机抽取的主花色是：" + suit);
      ws.send(JSON.stringify({ type: "deal_cards", rank_input: rank, suit_input: suit }));
    }
  </script>
</body>
</html>